<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time PDF Sync</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            height: 100vh;
            margin: 0;
        }
        #pdf-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            width: 70%;
        }
        #sidebar {
            width: 30%;
            background: #f5f5f5;
            padding: 20px;
            overflow-y: auto;
        }
        #sidebar h2 {
            text-align: center;
        }
        .user-item {
            margin-bottom: 10px;
        }
        #chatBox {
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        #chatInput {
            width: 100%;
            padding: 10px;
        }
        #sendMessage {
            padding: 10px;
            width: 100%;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            margin-top: 5px;
        }
    </style>
</head>
<body>
<div id="pdf-container">
    <input type="file" id="pdfFile" accept="application/pdf">
</div>

<div id="sidebar">
    <h2>Users</h2>
    <ul id="userList"></ul>

    <h2>Chat</h2>
    <div id="chatBox"></div>
    <input type="text" id="chatInput" placeholder="Enter your message...">
    <button id="sendMessage">Send</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
<script>
    let currentPage = 1;
    let pdfDoc = null;
    let socket = new WebSocket("ws://localhost:8080/sync");

    // Store the users and their current pages
    let users = {};

    // Open WebSocket connection
    socket.addEventListener("open", function(event) {
        console.log("Connected to WebSocket");
    });

    // Function to update the user list in the sidebar
    function updateUserList() {
        const userList = document.getElementById("userList");
        userList.innerHTML = "";  // Clear current list

        for (const userId in users) {
            const li = document.createElement("li");
            li.classList.add("user-item");
            li.innerHTML = `<span>User ${userId}:</span> Page ${users[userId]}`;
            userList.appendChild(li);
        }
    }

    // Handle messages from the server
    socket.addEventListener("message", function(event) {
        const message = event.data;
        console.log("Received message:", message);

        try {
            // Handle user progress update (when they are on a new page)
            if (message.startsWith("User") && message.includes("is now on page")) {
                const parts = message.split(":");
                if (parts.length >= 2) {
                    const [userId, page] = parts[1].split("-");
                    if (userId && page) {
                        users[userId] = page;
                        updateUserList();  // Update the sidebar user list with new page number
                        displayUserProgress(userId, page);  // Update chat box with user progress
                    }
                }
            }

            // Handle new user joining
            else if (message.startsWith("New user joined:")) {
                const userId = message.split(":")[1].trim();
                if (userId) {
                    users[userId] = 1;  // New user starts at page 1
                    updateUserList();  // Update the sidebar user list
                    const chatBox = document.getElementById("chatBox");
                    const newUserMessage = document.createElement("div");
                    newUserMessage.textContent = `User ${userId} has joined the session.`;
                    chatBox.appendChild(newUserMessage);
                    chatBox.scrollTop = chatBox.scrollHeight;  // Scroll to bottom of chat
                }
            }

            // Handle chat messages
            else if (message.includes(": Chat:")) {
                const [userId, chatMessage] = message.split(": Chat:");
                if (userId && chatMessage) {
                    const chatBox = document.getElementById("chatBox");
                    const newMessage = document.createElement("div");
                    newMessage.textContent = `${userId}: ${chatMessage}`;
                    chatBox.appendChild(newMessage);
                    chatBox.scrollTop = chatBox.scrollHeight;  // Scroll to bottom of chat
                }
            }
            else {
                console.log("Unexpected message format:", message);
            }
        } catch (error) {
            console.error("Error processing WebSocket message:", error);
        }
    });

    // Function to send the current page update to the WebSocket server
    function sendPageUpdate() {
        const message = "page:" + currentPage;
        socket.send(message);  // Send page update message
    }

    // Function to load PDF file from the input
    function loadPdf(file) {
        const reader = new FileReader();

        reader.onload = function(e) {
            const pdfData = new Uint8Array(e.target.result);
            pdfjsLib.getDocument(pdfData).promise.then(function(pdf) {
                pdfDoc = pdf;
                renderPages();  // Render all pages
            });
        };

        reader.readAsArrayBuffer(file);
    }

    // Render all pages of the PDF file
    function renderPages() {
        const container = document.getElementById('pdf-container');
        container.innerHTML = '';  // Clear any previous content

        for (let i = 1; i <= pdfDoc.numPages; i++) {
            renderPage(i);
        }
    }

    // Render a specific page
    function renderPage(pageNum) {
        pdfDoc.getPage(pageNum).then(function(page) {
            const scale = 1.5;
            const viewport = page.getViewport({ scale: scale });
            const canvas = document.createElement('canvas');
            canvas.classList.add('pdf-page');
            const context = canvas.getContext('2d');

            canvas.height = viewport.height;
            canvas.width = viewport.width;

            page.render({
                canvasContext: context,
                viewport: viewport
            });

            document.getElementById('pdf-container').appendChild(canvas);
        });
    }

    // Detect page scroll and send page update
    document.getElementById('pdf-container').addEventListener('scroll', function () {
        const container = document.getElementById('pdf-container');
        const pageHeight = container.firstChild ? container.firstChild.clientHeight : 0;

        const currentScrollPosition = container.scrollTop;
        const newPage = Math.ceil(currentScrollPosition / pageHeight) + 1;

        if (newPage !== currentPage) {
            currentPage = newPage;
            sendPageUpdate();  // Send page update via WebSocket
        }
    });

    // Listen for file input and load the selected PDF
    document.getElementById('pdfFile').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            loadPdf(file);  // Load the selected PDF file
        }
    });

    // Listen for chat message submission
    document.getElementById("sendMessage").addEventListener("click", function() {
        const message = document.getElementById("chatInput").value.trim();
        if (message) {
            socket.send("Chat:" + message);  // Send chat message
            document.getElementById("chatInput").value = "";  // Clear input field
        }
    });

    // Allow pressing Enter to send message
    document.getElementById("chatInput").addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            document.getElementById("sendMessage").click();
        }
    });

    // Function to update the user list in the sidebar
    function updateUserList() {
        const userList = document.getElementById("userList");
        userList.innerHTML = "";  // Clear current list

        for (const userId in users) {
            const li = document.createElement("li");
            li.classList.add("user-item");
            li.innerHTML = `<span>User ${userId}:</span> Page ${users[userId]}`;
            userList.appendChild(li);
        }
    }

    // Function to display user progress in the chat box
    function displayUserProgress(userId, page) {
        const chatBox = document.getElementById("chatBox");
        const progressMessage = document.createElement("div");
        progressMessage.textContent = `User ${userId} is now on page ${page}`;
        chatBox.appendChild(progressMessage);
        chatBox.scrollTop = chatBox.scrollHeight;  // Scroll to the bottom of chat
    }

    // Function to send the user page update to WebSocket when a user joins
    function userJoined(userId, page) {
        socket.send(`User:${userId} is now on page ${page}`);
    }
</script>
</body>
</html>
